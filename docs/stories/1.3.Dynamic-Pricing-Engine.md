# Story 1.3: Dynamic Pricing Engine

## Status
Done

## Story
**As a** Billing Company user,
**I want** to create and manage a default price schedule for each Laboratory and custom price schedules for specific Clinics,
**so that** I can handle complex pricing agreements.

## Acceptance Criteria
1.  A new "Pricing" section is available in the Settings area.
2.  Billing Company users can create and manage a default price schedule for each Laboratory.
3.  Billing Company users can create and manage custom price schedules for individual Clinics.
4.  Price schedules can be created by importing a CSV or Excel file.
5.  When an invoice is generated, the system correctly applies the custom price schedule if one exists, otherwise it falls back to the default Laboratory schedule.
6.  The UI for managing price schedules is intuitive and allows for easy editing of CPT code prices.

## Tasks / Subtasks
- [x] **Task 1: Database Schema for Pricing**
    - [x] Create a new SQL migration file to add the `price_schedules` and `price_schedule_items` tables.
    - [x] The `price_schedules` table should be linkable to either a Laboratory or a Clinic.
- [x] **Task 2: Create Pricing Management UI**
    - [x] Create a new `PricingSettings.tsx` component in the `src/components/settings` directory.
    - [x] Add a new route for this component in `src/pages/Settings.tsx`.
    - [x] Design and build a UI for creating, viewing, and editing price schedules and their items.
- [x] **Task 3: Implement Price Schedule Import**
    - [x] Add a file import feature to the `PricingSettings` component.
    - [x] Create a new Supabase Edge Function (`import-price-schedule`) to parse the uploaded file and populate the pricing tables.
- [x] **Task 4: Implement Pricing Logic**
    - [x] Create a new `pricing.service.ts` file in the `src/api/services` directory.
    - [x] Implement a function that, given a `clinic_id` and a list of CPT codes, returns the correct price for each code by checking for a custom schedule first, then falling back to the default.
- [x] **Task 5: Integrate Pricing Logic with Invoicing**
    - [x] Modify the invoice generation logic (both manual and automated) to use the new pricing service to calculate line item totals.
- [x] **Task 6: Documentation and Rollback**
    - [x] Document the new pricing tables and the `import-price-schedule` Edge Function.
    - [x] Add rollback procedures for the new database tables to `docs/ROLLBACK_PROCEDURES.md`.

## Dev Notes
This story introduces the core logic for one of the most critical new features. The pricing engine must be accurate and reliable. The developer should pay close attention to the fallback logic (custom schedule -> default schedule).

### Testing
-   Write unit tests for the pricing service to cover all scenarios (custom price, default price, CPT code not found).
-   Write tests for the `import-price-schedule` Edge Function.
-   Manually test the entire pricing workflow, from creating a schedule to generating an invoice and verifying the line item totals.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- | --- |
| 2025-08-01 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-08-01 | 1.1 | Updated status and completed initial tasks for DB and UI. | James (Developer) |
| 2025-08-01 | 1.2 | Implemented data fetching and basic UI for pricing settings. | James (Developer) |
| 2025-08-01 | 1.3 | Final QA review passed. | Quinn (QA) |