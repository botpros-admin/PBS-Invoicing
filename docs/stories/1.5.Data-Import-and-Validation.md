# Story 1.5: Data Import and Validation

## Status
Done

## Story
**As a** Billing Company user,
**I want** to upload a CSV or Excel file with billing data, have it validated against the system's data, and see a clear report of any errors,
**so that** I can efficiently import data from external systems.

## Acceptance Criteria
1.  A data import feature is available in the "Import Data" section of the application.
2.  Users can upload CSV or Excel files.
3.  The system parses the file and validates each row.
4.  Validation checks include ensuring that Clinic names and CPT codes exist in the system.
5.  The system prevents the import of duplicate line items based on the `accession_number` and `cpt_code` combination.
6.  A preview of the parsed data is shown to the user, highlighting any errors or warnings (e.g., duplicates).
7.  Users can manually override duplicate warnings to import the data.
8.  After processing, a summary report is displayed showing the number of successful imports, duplicates, and errors.
9.  A downloadable error report is available for failed rows.

## Tasks / Subtasks
- [x] **Task 1: Create Data Import UI** (AC: #1, #6)
    - [x] Enhance the existing `ImportData.tsx` page to include a file dropzone and a preview table.
    - [x] The preview table should clearly indicate the status of each row (Valid, Duplicate, Error) and display validation messages.
- [x] **Task 2: Develop File Parsing and Validation Logic** (AC: #2, #3, #4, #5)
    - [x] Create a new Supabase Edge Function (`import-data`) to handle file processing.
    - [x] The function will parse the uploaded CSV/Excel file.
    - [x] Implement validation logic within the function to check for existing clinics, CPT codes, and duplicate line items.
    - [x] The function should return a structured JSON response with the parsed data, including validation status for each row.
- [x] **Task 3: Implement Import Processing** (AC: #7, #8, #9)
    - [x] Add a "Process Import" button to the UI that calls the `import-data` function again with a flag to commit the data.
    - [x] The backend function will insert the valid data into the `invoice_line_items` table.
    - [x] The function will generate and store an error report for any failed rows.
    - [x] The UI will display the final import summary and provide a link to download the error report.
- [x] **Task 4: Documentation and Rollback**
    - [x] Document the `import-data` Edge Function and the expected file format in the project's `README.md`.
    - [x] Add rollback procedures to `docs/ROLLBACK_PROCEDURES.md`, detailing how to handle a failed import.

## Dev Notes
This feature is complex and involves frontend, backend, and file processing logic. The developer should focus on creating a robust and user-friendly import experience. Clear error messaging is critical. The `import-data` function should be designed to be idempotent where possible to prevent partial imports on failure.

### Testing
-   Write unit tests for the file parsing and validation logic in the Edge Function.
-   Create a suite of test files (CSV and Excel) with valid, invalid, and duplicate data to test the entire import workflow.
-   Manually test the end-to-end process, including the UI feedback and error reporting.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- | --- |
| 2025-08-01 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-08-01 | 1.1 | Updated status and completed initial tasks for UI and Edge Function. | James (Developer) |
| 2025-08-01 | 1.2 | Final QA review passed. | Quinn (QA) |
