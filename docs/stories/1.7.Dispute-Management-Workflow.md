# Story 1.7: Dispute Management Workflow

## Status
Done

## Story
**As a** Clinic user,
**I want** to be able to dispute a line item on an invoice and track the status of my dispute,
**so that** I can resolve billing discrepancies efficiently.

## Acceptance Criteria
1.  On the "Invoice Detail" page, Clinic users can see a "Dispute" button next to each line item.
2.  Clicking the "Dispute" button opens a modal where the user can enter a reason for the dispute.
3.  Once a dispute is submitted, the line item is visually marked as "Disputed" on the invoice.
4.  Billing Company users receive a notification when a new dispute is filed.
5.  Billing Company users have an interface to review and resolve disputes (accept, partially accept, or reject).
6.  The resolution and any notes are visible to the Clinic user.
7.  A line item can only be disputed once.

## Tasks / Subtasks
- [x] **Task 1: Enhance Invoice Detail UI** (AC: #1, #3)
    - [x] Modify the `InvoiceDetail.tsx` component to include a "Dispute" button for each line item, visible only to Clinic users.
    - [x] Add a visual indicator (e.g., a badge) to highlight disputed line items.
- [x] **Task 2: Create Dispute Modal** (AC: #2)
    - [x] Create a new `DisputeModal.tsx` component.
    - [x] The modal should contain a form for submitting a dispute reason.
- [x] **Task 3: Implement Dispute Submission Logic** (AC: #4)
    - [x] Create a new `dispute.service.ts` file in the `src/api/services` directory.
    - [x] Implement a `submitDispute` function that updates the `invoice_line_items` table to mark an item as disputed.
    - [x] Trigger a notification to the Billing Company users when a dispute is submitted.
- [x] **Task 4: Create Dispute Resolution UI** (AC: #5, #6)
    - [x] Create a new "Dispute Resolution" section in the application for Billing Company users.
    - [x] This interface should display a list of all open disputes.
    - [x] Provide a UI for reviewing the dispute and setting its status (Accepted, Rejected, etc.).
- [x] **Task 5: Implement Dispute Resolution Logic** (AC: #7)
    - [x] Implement a `resolveDispute` function in the `dispute.service.ts`.
    - [x] This function will update the dispute status and prevent further disputes on the same line item.
- [x] **Task 6: Documentation and Rollback**
    - [x] Document the new dispute management workflow.
    - [x] Add rollback procedures to `docs/ROLLBACK_PROCEDURES.md`.

## Dev Notes
This story introduces a new workflow that requires careful handling of state and user permissions. The developer should ensure that the dispute status is clearly communicated to both Clinic and Billing Company users.

### Testing
-   Write tests for the `dispute.service.ts` functions.
-   Manually test the end-to-end dispute workflow from the perspective of both a Clinic user and a Billing Company user.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- | --- |
| 2025-08-01 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-08-01 | 1.1 | Completed initial UI and service implementation. | James (Developer) |
| 2025-08-01 | 1.2 | Final QA review passed. | Quinn (QA) |
