# Story 1.4: Advanced Invoice Data Model

## Status
Done

## Story
**As a** developer,
**I want** to refactor the invoice data model to support multiple patients and accession numbers per invoice,
**so that** the system can accommodate complex billing scenarios.

## Acceptance Criteria
1.  The `invoices` table no longer contains a direct `patient_id`.
2.  The `invoice_line_items` table is created.
3.  The `invoice_line_items` table includes a `patient_id` and `accession_number`.
4.  A database migration script is created to apply these changes.
5.  Existing invoice-related API services are updated to reflect the new data model.
6.  Rollback procedures for the schema changes are documented.

## Tasks / Subtasks
- [x] **Task 1: Refactor Database Schema** (AC: #1, #2, #3, #4)
    - [x] Create a new SQL migration file.
    - [x] Add SQL to remove the `patient_id` column from the `invoices` table.
    - [x] Add SQL to create the `invoice_line_items` table.
    - [x] Add SQL to add `patient_id` and `accession_number` columns to the `invoice_line_items` table.
- [x] **Task 2: Update API Services** (AC: #5)
    - [x] Modify the `invoice.service.ts` file to align with the new schema.
    - [x] Update the `getInvoiceById` function to correctly join and retrieve line items with patient data.
    - [x] Update the `createInvoice` and `updateInvoice` functions to handle the new data structure.
- [x] **Task 3: Update Frontend Components**
    - [x] Refactor the `InvoiceDetail.tsx`, `CreateInvoice.tsx`, and any other components that interact with invoice data to use the new data model.
- [x] **Task 4: Documentation and Rollback** (AC: #6)
    - [x] Document the new invoice data model in the `brownfield-architecture.md` document.
    - [x] Add rollback procedures for this migration to `docs/ROLLBACK_PROCEDURES.md`.

## Dev Notes
This is a significant refactoring that will impact many parts of the application. It is crucial to ensure that all API services and frontend components are updated to work with the new data model. The developer should pay close attention to the relationships between invoices, line items, and patients.

### Testing
-   Write unit tests for the updated invoice service functions.
-   Manually test the entire invoice workflow, from creation to viewing details, to ensure that the application works correctly with the new data model.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- | --- |
| 2025-08-01 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-08-01 | 1.1 | Completed DB schema and API service updates. | James (Developer) |
| 2025-08-01 | 1.2 | Refactored frontend components for new data model. | James (Developer) |
| 2025-08-01 | 1.3 | Final QA review passed. | Quinn (QA) |