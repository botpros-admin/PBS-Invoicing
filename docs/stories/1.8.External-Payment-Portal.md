# Story 1.8: External Payment Portal

## Status
Done

## Story
**As a** Clinic user without an account,
**I want** to be able to pay an invoice using only the invoice number,
**so that** I can easily make payments without needing to log in.

## Acceptance Criteria
1.  A new public-facing page is created at `/pay-invoice`.
2.  The page contains a simple form to enter an invoice number.
3.  Upon submitting the invoice number, the system retrieves the invoice details without displaying any patient information.
4.  The user is presented with the total amount due and a payment form (integrated with Stripe).
5.  After a successful payment, the user sees a confirmation message.
6.  The corresponding invoice in the system is updated with the payment details.

## Tasks / Subtasks
- [x] **Task 1: Create Public Payment Page** (AC: #1, #2)
    - [x] Create a new `PayInvoice.tsx` component in the `src/pages` directory.
    - [x] Add a new public route for this page in `src/App.tsx`.
    - [x] Design a simple and secure form for entering an invoice number.
- [x] **Task 2: Implement Invoice Retrieval** (AC: #3)
    - [x] Create a new Supabase Edge Function (`get-invoice-for-payment`) that takes an invoice number and returns only the necessary, non-sensitive data (e.g., total amount due).
    - [x] This function must not expose any Protected Health Information (PHI).
- [x] **Task 3: Integrate Payment Gateway** (AC: #4)
    - [x] Integrate the Stripe payment element into the `PayInvoice.tsx` component.
    - [x] Create a new Supabase Edge Function (`process-payment`) to handle the payment processing with Stripe.
- [x] **Task 4: Update Invoice on Payment** (AC: #5, #6)
    - [x] After a successful payment, the `process-payment` function should update the corresponding invoice in the database with the payment details.
    - [x] The frontend should display a clear success or failure message to the user.
- [x] **Task 5: Documentation and Rollback**
    - [x] Document the new public payment workflow and the associated Edge Functions.
    - [x] Add rollback procedures to `docs/ROLLBACK_PROCEDURES.md`.

## Dev Notes
Security is the top priority for this story. The developer must ensure that no sensitive patient information is ever exposed on the public payment page. The workflow should be as simple and streamlined as possible to encourage prompt payments.

### Testing
-   Write tests for the `get-invoice-for-payment` and `process-payment` Edge Functions.
-   Manually test the entire payment workflow with both valid and invalid invoice numbers.
-   Perform security testing to ensure that no sensitive data is leaked.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- | --- |
| 2025-08-01 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-08-01 | 1.1 | Completed initial UI and Edge Function implementation. | James (Developer) |
| 2025-08-01 | 1.2 | Final QA review passed. | Quinn (QA) |
