# Story 1.2: User Management for All Roles

## Status
Done

## Story
**As a** Billing Company user,
**I want** a user management interface to invite, view, and manage Laboratory and Clinic users, assigning them the appropriate roles,
**so that** I can control access to the system.

## Acceptance Criteria
1.  A new "User Management" section is available in the Settings area for Billing Company users.
2.  Billing Company users can invite new users by email to join a specific Laboratory or Clinic.
3.  When inviting a user, the Billing Company user can assign them a "Laboratory" or "Clinic" role.
4.  The interface displays a list of all users, showing their name, email, assigned Laboratory/Clinic, role, and status (e.g., Invited, Active).
5.  Billing Company users can resend invitations to users with an "Invited" status.
6.  Billing Company users can deactivate or reactivate existing users.
7.  The implementation reuses and adapts the existing UI components for consistency.

## Tasks / Subtasks
- [x] **Task 1: Create User Management UI** (AC: #1, #4)
    - [x] Create a new `UserManagement.tsx` component within the `src/components/settings` directory.
    - [x] Add a new route for this component in `src/pages/Settings.tsx`.
    - [x] Build a table to display the list of users, using the existing `DataTable` component.
- [x] **Task 2: Implement User Invitation Logic** (AC: #2, #3)
    - [x] Create a modal for the user invitation form.
    - [x] Develop a new Supabase Edge Function (`invite-user`) that handles sending invitation emails.
    - [x] The function should accept an email address, role, and either a `lab_id` or `clinic_id`.
    - [x] Call the `invite-user` function from the frontend when the form is submitted.
- [x] **Task 3: Implement User Status Management** (AC: #5, #6)
    - [x] Add buttons to the user management table for "Resend Invitation", "Deactivate", and "Activate".
    - [x] Create new API service functions to handle these actions. These will likely update the user's status in the `users` or `client_users` table.
- [x] **Task 4: Backend and RLS adjustments**
    - [x] Ensure that the RLS policies from Story 1.1 correctly allow Billing Company users to view and manage all users in their organization.
    - [x] Create a new API endpoint or function to fetch all users associated with an organization.
- [x] **Task 5: Documentation and Rollback**
    - [x] Document the new `invite-user` Edge Function in the `README.md`.
    - [x] Add rollback procedures for this story to `docs/ROLLBACK_PROCEDURES.md`.

## Dev Notes
This story builds directly on the database schema from Story 1.1. The developer must ensure that the database migration from the previous story has been applied before starting work. The focus should be on creating a clean, intuitive UI for user management that leverages the existing design system.

### Testing
-   Write tests for the new `invite-user` Edge Function.
-   Write frontend tests for the `UserManagement.tsx` component to ensure it correctly displays users and that the invitation form works as expected.
-   Manually test the full user invitation and management flow, ensuring that emails are sent and that user statuses are updated correctly.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- | --- |
| 2025-08-01 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-08-01 | 1.1 | Updated status and completed initial tasks for UI and Edge Function. | James (Developer) |
| 2025-08-01 | 1.2 | Implemented user data fetching and invitation logic. | James (Developer) |
| 2025-08-01 | 1.3 | Completed implementation and moved to Review. | James (Developer) |
| 2025-08-01 | 1.4 | Final QA review passed. | Quinn (QA) |
